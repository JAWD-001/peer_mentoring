{% extends 'base.html %}

{% block title %}Chat room for "{{group.title}}" {% endblock %}

{% block content %}
<div id="chat">
</div>
<div id="chat_input">
    <input id="chat-message-input" type="text">
    <input id="chat-message-submit" type="submit" value="Send">
</div>

{% endblock %}

{% block include_js %}
    {{ group.id|json_script:"group-id" }}
{% endblock %}

{% block domready %}
    const groupId = JSON.parse(
        document.getElementById('group-id'.textContent
    );
    const url = 'ws://' + window.location.host +
                '/ws/chat/room/' + groupId + '/';
    const chatSocket = new WebSocket(url);

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const chat = document.getElementById('chat');

        chat.innerHTML += '<div class="message">' +
                            data.message + '</div>';
        chat.scrollTop = chat.scrollHeight;
    };

    chatSocket.onclose = function(event) {
        console.error('Chat socket closed unexpectedly');
    };

    const input = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');

    submitButton.addEventListener('click', function(event) {
        const message = input.value;
        if (message) {
            chatSocket.send(JSON.stringify({'message': message}));
        input.innerHTML = '';
        input.focus();
        }
    });

    input.addEventListener('keypress', function(event) {
        if (event.key == 'Enter') {
            event.preventDefault();
            submitButton.click();
        }
    });

    input.focus();
{% endblock %}